<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>FichaD&D</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Mate+SC&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">

<style>
    :root {
      /* Cores do Tema Grim칩rio */
      --gold-primary: #d4af37;
      --gold-dim: #8a7326;
      --gold-bright: #ffdf80;
      --bg-dark: #0a0a0c;
      --panel-bg: rgba(20, 20, 25, 0.95);
      --crimson: #8a0303;
      --crimson-light: #b91212;
      --text-main: #e0d8c3;
      
      /* Cores Legadas (Interior da Ficha) */
      --bg-paper: #f9f5e6;       
      --bg-dark-paper: #e8dfc5;        
      --ink-color: #2b2118;      
      --accent-color: #8b4513;   
      --border-color: #5c4a3d;   
    }

    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background-color: #0a0a0c !important; 
      background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 100%) !important;
      color: var(--text-main);
      font-family: 'Crimson Pro', serif;
      overflow: hidden; 
    }

    /* --- ESTILOS DA INTERFACE --- */
    .lang-selector {
      position: fixed; top: 90px; left: 3vw;
      background: var(--panel-bg); border: 1px solid var(--gold-dim);
      padding: 0.5rem 1rem; border-radius: 4px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      display: flex; align-items: center;
      font-size: 0.9rem; z-index: 100;
      font-family: 'Cinzel', serif; color: var(--gold-primary);
    }
    .lang-selector label { margin: 0 0.5rem; color: var(--gold-bright); }
    input[type=range] { accent-color: var(--gold-primary); }

    .btn-arcane {
      font-family: 'Cinzel', serif; text-transform: uppercase;
      letter-spacing: 1px; font-weight: bold;
      border: 1px solid var(--gold-dim);
      box-shadow: 0 4px 6px rgba(0,0,0,0.5); transition: all 0.3s ease;
      color: var(--gold-bright); background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
      position: fixed; left: 3vw; z-index: 100;
      width: 160px; text-align: center; padding: 10px 0; border-radius: 4px;
    }
    .btn-arcane:hover {
      border-color: var(--gold-primary); box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
      color: #fff; transform: translateY(-2px);
    }
    .btn-download { top: 150px; }
    .btn-save {
      top: 210px;
      background: linear-gradient(180deg, var(--crimson) 0%, #520000 100%);
      border-color: #ff4444; color: #ffd700;
    }
    .btn-save:hover {
      background: linear-gradient(180deg, var(--crimson-light) 0%, #7a0000 100%);
      box-shadow: 0 0 15px var(--crimson);
    }

    /* --- PREVIEW BOX --- */
    .preview-box {
      position: fixed; top: 90px; right: 3vw;
      width: 65vw; height: calc(100vh - 110px);
      border: 2px solid var(--gold-dim); border-radius: 8px;
      box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.5);
      background: #222; padding: 40px 0;
      box-sizing: border-box; overflow-y: auto;
      display: flex; flex-direction: column; align-items: center;
      scrollbar-width: thin; scrollbar-color: var(--gold-dim) #111;
    }
    .preview-box::-webkit-scrollbar { width: 10px; }
    .preview-box::-webkit-scrollbar-track { background: #111; }
    .preview-box::-webkit-scrollbar-thumb { background-color: var(--gold-dim); border-radius: 5px; border: 2px solid #111; }

    /* --- FICHA INTERNA --- */
    .scale-wrapper {
        width: 100%; display: flex; flex-direction: column; align-items: center;
        gap: 30px; padding-bottom: 50px;
        transform: scale(0.9); transform-origin: top center;
    }
    .scale-wrapper > * {
        width: 800px !important; min-width: 800px !important; max-width: 800px !important;
        margin: 0 !important; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        background-color: var(--bg-paper); color: var(--ink-color); 
        box-sizing: border-box; 
    }
    .scale-wrapper input, .scale-wrapper textarea, .scale-wrapper select {
        background-color: transparent; color: var(--ink-color) !important;
        border-color: var(--border-color); font-family: 'Crimson Text', serif !important;
    }
    .scale-wrapper input:focus, .scale-wrapper textarea:focus {
        outline: none !important; box-shadow: none !important; border-color: var(--accent-color) !important;
    }
    .spell-slot.bg-black { background-color: #000 !important; color: white !important; }
</style>

  <script src="https://unpkg.com/vue@3.5.13/dist/vue.global.js"></script>
</head>

<body>
  {% include "components/navbar.html" %}

  <div class="lang-selector">
    <label for="lang-range">PT</label>
    <input type="range" id="lang-range" min="0" max="1" step="1" value="{% if current_lang == 'en' %}1{% else %}0{% endif %}">
    <label for="lang-range">EN</label>
  </div>

  <button onclick="gerarPDF()" class="btn btn-arcane btn-download">
    <span class="mr-2">游닆</span> Baixar PDF
  </button>

  <button onclick="salvarFicha()" class="btn btn-arcane btn-save">
    <span class="mr-2">游</span> Salvar Ficha
  </button>

  {{ full_data_json|json_script:"char-data" }}

  <div class="preview-box">
    <div class="scale-wrapper">
      {% include "pages/template_ficha_folha_1.html" %}
      {% include "pages/template_ficha_folha_2.html" %}
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('lang-range').addEventListener('change', function(e) {
        const lang = e.target.value === '1' ? 'en' : 'pt';
        const url = new URL(window.location);
        url.searchParams.set('lang', lang);
        window.location = url;
    });

    function gerarPDF() {
        const preview = document.querySelector('.preview-box');
        const wrapper = preview.querySelector('.scale-wrapper');
        document.querySelectorAll('.navbar, .lang-selector, .btn-arcane').forEach(el => el.style.display = 'none');
        
        const origHeight = preview.style.height;
        const origOverflow = preview.style.overflow;
        const origTransform = wrapper.style.transform;
        
        preview.style.height = 'auto';
        preview.style.overflow = 'visible';
        wrapper.style.transform = 'none'; 
        wrapper.style.width = 'fit-content'; 

        const opt = {
            margin: 0,
            filename: `ficha_{{ charname }}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(wrapper).save().then(() => {
            document.querySelectorAll('.navbar, .lang-selector, .btn-arcane').forEach(el => el.style.display = 'flex');
            wrapper.style.transform = origTransform;
            wrapper.style.width = '100%';
            preview.style.height = origHeight;
            preview.style.overflow = origOverflow;
        });
    }

    // --- MAPA DE CAMPOS (Centralizado para uso no Load e Save) ---
    const MAPPING = {
        'classlevel': 'classe',
        'ac': 'ca',
        'features': 'features_traits', // Mapeia input 'features' para JSON 'features_traits'
        'equipment': 'formatted_all_equipment',
        'personality': 'personality_traits',
        'remaininghd': 'hit_dice',
        'totalhd': 'total_hd'
    };

    // Campos simples (texto/numero)
    const SIMPLE_FIELDS = [
        'charname', 'classlevel', 'background', 'playername', 'race', 
        'alignment', 'xp', 'ac', 'speed', 'maxhp', 'temphp', 'currenthp', 
        'personality', 'ideals', 'bonds', 'flaws', 'features', 'equipment',
        'cp', 'sp', 'ep', 'gp', 'pp', 'otherprofs', 'passiveperception',
        'initiative', 'remaininghd', 'totalhd',
        'atkname1', 'atkbonus1', 'atkdamage1',
        'atkname2', 'atkbonus2', 'atkdamage2',
        'atkname3', 'atkbonus3', 'atkdamage3'
    ];

    // --- FUN칂츾O 1: CARREGAR DADOS DO JSON PARA O HTML (NOVO) ---
    function loadCharDataToDOM(charData) {
        if (!charData) return;

        // 1. Campos Simples
        SIMPLE_FIELDS.forEach(field => {
            const jsonKey = MAPPING[field] || field;
            const el = document.querySelector(`[name="${field}"]`);
            if (el && charData[jsonKey] !== undefined) {
                el.value = charData[jsonKey];
            }
        });

        // 2. Atributos
        if (charData.atributo) {
            ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'].forEach(attr => {
                const el = document.querySelector(`[name="${attr}score"]`);
                const val = charData.atributo[attr.toLowerCase()];
                if (el && val !== undefined) el.value = val;
            });
        }

        // 3. Modificadores
        if (charData.mod) {
             const mods = { 'Strength': 'str', 'Dexterity': 'dex', 'Constitution': 'con', 'Intelligence': 'int', 'Wisdom': 'wis', 'Charisma': 'cha' };
             for (const [attr, key] of Object.entries(mods)) {
                 const el = document.querySelector(`[name="${attr}mod"]`);
                 if (el && charData.mod[key] !== undefined) el.value = charData.mod[key];
             }
        }

        // 4. Checkboxes (Per칤cias e Saves)
        // Varre o JSON procurando chaves que coincidem com names de checkboxes
        document.querySelectorAll('input[type="checkbox"]').forEach(box => {
            if(box.name && charData[box.name] !== undefined) {
                box.checked = charData[box.name];
            }
        });
    }

    // --- FUN칂츾O 2: CAPTURAR DADOS DO HTML PARA SALVAR ---
    function updateCharDataFromDOM(charData) {
        const getVal = (name) => {
            const el = document.querySelector(`[name="${name}"]`);
            if (!el) return null;
            if (el.type === 'checkbox') return el.checked;
            return el.value;
        };

        // Campos Simples
        SIMPLE_FIELDS.forEach(field => {
            const val = getVal(field);
            if (val !== null) {
                const key = MAPPING[field] || field;
                charData[key] = val;
            }
        });

        // Atributos
        if (!charData.atributo) charData.atributo = {};
        ['Strength', 'Dexterity', 'Constitution', 'Intelligence', 'Wisdom', 'Charisma'].forEach(attr => {
            const score = getVal(`${attr}score`);
            if (score !== null) charData.atributo[attr.toLowerCase()] = score;
        });
        
        // Modificadores
        if (!charData.mod) charData.mod = {};
        const mods = { 'Strength': 'str', 'Dexterity': 'dex', 'Constitution': 'con', 'Intelligence': 'int', 'Wisdom': 'wis', 'Charisma': 'cha' };
        for (const [attr, key] of Object.entries(mods)) {
            const val = getVal(`${attr}mod`);
            if(val !== null) charData.mod[key] = val;
        }

        // Checkboxes Gerais
        document.querySelectorAll('input[type="checkbox"]').forEach(box => {
            if(box.name) {
                charData[box.name] = box.checked;
            }
        });

        return charData;
    }

    // --- INICIALIZA칂츾O: CARREGA DADOS AO ABRIR ---
    document.addEventListener("DOMContentLoaded", () => {
        try {
            const rawData = document.getElementById('char-data').textContent;
            const charData = JSON.parse(rawData);
            // Preenche os campos imediatamente para garantir que o usu치rio veja o que salvou
            loadCharDataToDOM(charData);
        } catch(e) {
            console.error("Erro ao carregar dados da ficha:", e);
        }
    });

    async function salvarFicha() {
        const usuarioLogado = {{ user.is_authenticated|yesno:"true,false" }};

        if (!usuarioLogado) {
            if (confirm("Voc칡 precisa estar logado para salvar. Deseja entrar agora?")) {
                window.location.href = "{% url 'login' %}"; 
            }
            return;
        }

        console.log("Iniciando salvamento..."); 

        const dataElement = document.getElementById('char-data');
        if (!dataElement) {
            alert("Erro cr칤tico: Dados da ficha n칚o encontrados.");
            return;
        }
        
        let rawData = dataElement.textContent;
        let charData = JSON.parse(rawData);

        // Atualiza o JSON com o que est치 na tela
        charData = updateCharDataFromDOM(charData);

        const csrftoken = getCookie('csrftoken');
        const url = "/charsheet/"; 

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(charData)
            });

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") === -1) {
                throw new Error("Erro de servidor. Verifique se est치 logado.");
            }

            const result = await response.json();

            if (response.ok) {
                alert("Sucesso: " + (result.message || "Ficha salva!"));
                // Atualiza o JSON script na p치gina para refletir o novo estado
                document.getElementById('char-data').textContent = JSON.stringify(charData);
            } else {
                console.error("Erro no backend:", result);
                alert("Erro ao salvar: " + (result.error || "Erro desconhecido"));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert("Ocorreu um erro de conex칚o.");
        }
    }
</script>
</body>
</html>