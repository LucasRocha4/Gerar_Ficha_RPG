<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>FichaD&D</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Mate+SC&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">

<style>
    :root {
      /* Cores do Tema GrimÃ³rio */
      --gold-primary: #d4af37;
      --gold-dim: #8a7326;
      --gold-bright: #ffdf80;
      --bg-dark: #0a0a0c;
      --panel-bg: rgba(20, 20, 25, 0.95);
      --crimson: #8a0303;
      --crimson-light: #b91212;
      --text-main: #e0d8c3;
      
      /* Cores Legadas (Interior da Ficha) */
      --bg-paper: #f9f5e6;       
      --bg-dark-paper: #e8dfc5;        
      --ink-color: #2b2118;      
      --accent-color: #8b4513;   
      --border-color: #5c4a3d;   
    }

    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      
      /* Fundo Arcano */
      background-color: #0a0a0c !important; 
      background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 100%) !important;
      
      color: var(--text-main);
      font-family: 'Crimson Pro', serif;
      overflow: hidden; 
    }

    /* --- ESTILOS DA INTERFACE --- */

    .lang-selector {
      position: fixed;
      top: 90px;
      left: 3vw;
      background: var(--panel-bg);
      border: 1px solid var(--gold-dim);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      z-index: 100;
      font-family: 'Cinzel', serif;
      color: var(--gold-primary);
    }

    .lang-selector label { margin: 0 0.5rem; color: var(--gold-bright); }
    
    input[type=range] {
      accent-color: var(--gold-primary);
    }

    /* BotÃµes Arcanos */
    .btn-arcane {
      font-family: 'Cinzel', serif;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: bold;
      border: 1px solid var(--gold-dim);
      box-shadow: 0 4px 6px rgba(0,0,0,0.5);
      transition: all 0.3s ease;
      color: var(--gold-bright);
      background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
      position: fixed;
      left: 3vw;
      z-index: 100;
      width: 160px;
      text-align: center;
      padding: 10px 0;
      border-radius: 4px;
    }

    .btn-arcane:hover {
      border-color: var(--gold-primary);
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
      color: #fff;
      transform: translateY(-2px);
    }

    .btn-download {
      top: 150px;
    }

    .btn-save {
      top: 210px;
      background: linear-gradient(180deg, var(--crimson) 0%, #520000 100%);
      border-color: #ff4444;
      color: #ffd700;
    }
    .btn-save:hover {
      background: linear-gradient(180deg, var(--crimson-light) 0%, #7a0000 100%);
      box-shadow: 0 0 15px var(--crimson);
    }

    /* --- MOLDURA DE PREVIEW --- */
    .preview-box {
      position: fixed;
      top: 90px;
      right: 3vw;
      width: 65vw;
      height: calc(100vh - 110px);
      border: 2px solid var(--gold-dim);
      border-radius: 8px;
      box-shadow: 
        0 0 30px rgba(0,0,0,0.8),
        inset 0 0 50px rgba(0,0,0,0.5);
      background: #222; 
      padding: 40px 0;
      box-sizing: border-box;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      scrollbar-width: thin;
      scrollbar-color: var(--gold-dim) #111;
    }

    .preview-box::-webkit-scrollbar { width: 10px; }
    .preview-box::-webkit-scrollbar-track { background: #111; }
    .preview-box::-webkit-scrollbar-thumb {
      background-color: var(--gold-dim);
      border-radius: 5px;
      border: 2px solid #111;
    }

    /* --- CONTEÃšDO DA FICHA (MANTIDO) --- */
    .scale-wrapper {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
        padding-bottom: 50px;
        transform: scale(0.9);
        transform-origin: top center;
    }

    .scale-wrapper > * {
        width: 800px !important;
        min-width: 800px !important;
        max-width: 800px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        background-color: var(--bg-paper);
        color: var(--ink-color); 
        box-sizing: border-box; 
    }

    /* AJUSTE: Relaxei as regras para nÃ£o quebrar caixas de modificadores */
    .scale-wrapper input, .scale-wrapper textarea, .scale-wrapper select {
        /* Remove o !important do background para permitir branco nos modificadores */
        background-color: transparent; 
        color: var(--ink-color) !important;
        border-color: var(--border-color);
        /* REMOVIDO: border-bottom-width: 1px; -> Isso transformava caixas em linhas */
        font-family: 'Crimson Text', serif !important;
    }
    
    /* Regra para garantir que inputs comuns pareÃ§am linhas, mas sem quebrar os outros */
    .scale-wrapper input:not([class*="modifier"]), 
    .scale-wrapper textarea:not([class*="modifier"]) {
       /* Se necessÃ¡rio, adicione classes especÃ­ficas aqui se os inputs padrÃ£o ficarem sem borda */
    }

    .scale-wrapper input:focus, .scale-wrapper textarea:focus {
        outline: none !important;
        box-shadow: none !important;
        border-color: var(--accent-color) !important;
    }

    /* Garante legibilidade em campos pretos (ex: spell slots) */
    .spell-slot.bg-black {
      background-color: #000 !important;
      color: white !important;
    }
</style>

  <script src="https://unpkg.com/vue@3.5.13/dist/vue.global.js"></script>
</head>

<body>
  {% include "components/navbar.html" %}

  <div class="lang-selector">
    <label for="lang-range">PT</label>
    <input type="range" id="lang-range" min="0" max="1" step="1" value="{% if current_lang == 'en' %}1{% else %}0{% endif %}">
    <label for="lang-range">EN</label>
  </div>

  <button onclick="gerarPDF()" class="btn btn-arcane btn-download">
    <span class="mr-2">ðŸ“œ</span> Baixar PDF
  </button>

  <button onclick="salvarFicha()" class="btn btn-arcane btn-save">
    <span class="mr-2">ðŸ’¾</span> Salvar Ficha
  </button>

  {{ full_data_json|json_script:"char-data" }}

  <div class="preview-box">
    <div class="scale-wrapper">
      {% include "pages/template_ficha_folha_1.html" %}
      {% include "pages/template_ficha_folha_2.html" %}
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('lang-range').addEventListener('change', function(e) {
        const lang = e.target.value === '1' ? 'en' : 'pt';
        const url = new URL(window.location);
        url.searchParams.set('lang', lang);
        window.location = url;
    });

    function gerarPDF() {
            const preview = document.querySelector('.preview-box');
            const wrapper = preview.querySelector('.scale-wrapper');
            
            document.querySelectorAll('.navbar, .lang-selector, .btn-arcane').forEach(el => el.style.display = 'none');

            const origHeight = preview.style.height;
            const origOverflow = preview.style.overflow;
            const origTransform = wrapper.style.transform;
            const origWidth = wrapper.style.width;
            const origMargin = wrapper.style.margin; 
            
            preview.style.height = 'auto';
            preview.style.overflow = 'visible';
            
            wrapper.style.transform = 'none'; 
            wrapper.style.width = '800px'; 
            wrapper.style.margin = '0 auto';
            
            const opt = {
                margin: 0,
                filename: `ficha_{{ charname }}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0,
                    windowWidth: 850 
                },
                jsPDF: { 
                    unit: 'px', 
                    format: [800, 1135], 
                    orientation: 'portrait' 
                }
            };

            html2pdf().set(opt).from(wrapper).save().then(() => {
                document.querySelectorAll('.navbar, .lang-selector, .btn-arcane').forEach(el => el.style.display = 'flex');
                wrapper.style.transform = origTransform;
                wrapper.style.width = origWidth;
                wrapper.style.margin = origMargin;
                preview.style.height = origHeight;
                preview.style.overflow = origOverflow;
            });
        }

    async function salvarFicha() {
        const usuarioLogado = {{ user.is_authenticated|yesno:"true,false" }};

        if (!usuarioLogado) {
            if (confirm("VocÃª precisa estar logado para salvar sua ficha no banco de dados. Deseja entrar ou criar uma conta agora?")) {
                window.location.href = "{% url 'login' %}"; 
            }
            return;
        }

        console.log("Iniciando salvamento..."); 

        const dataElement = document.getElementById('char-data');
        if (!dataElement) {
            alert("Erro: Dados da ficha nÃ£o encontrados no HTML.");
            return;
        }
        
        const rawData = dataElement.textContent;
        const charData = JSON.parse(rawData);
        const csrftoken = getCookie('csrftoken');
        const url = "fichas/"; 

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(charData)
            });

            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") === -1) {
                throw new Error("SessÃ£o expirada ou erro de URL.");
            }

            const result = await response.json();

            if (response.ok) {
                alert("Sucesso: " + (result.message || "Ficha salva!"));
            } else {
                console.error("Erro no backend:", result);
                alert("Erro ao salvar: " + (result.error || "Erro desconhecido"));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert("Ocorreu um erro. Se vocÃª nÃ£o estiver logado, recarregue a pÃ¡gina.");
        }
    }
</script>
</body>
</html>