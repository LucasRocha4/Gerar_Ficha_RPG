<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Pergaminho de Sugestões - FichaDnD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Mate+SC&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">

<style>
  :root {
      --gold-primary: #d4af37;
      --gold-dim: #8a7326;
      --gold-bright: #ffdf80;
      --bg-dark: #0a0a0c;
      --panel-bg: rgba(20, 20, 25, 0.95);
      --crimson: #8a0303;
      --text-main: #e0d8c3;
  }

  body { 
    background-color: var(--bg-dark);
    background-image: radial-gradient(circle at 50% 20%, #1a1a2e 0%, #000000 100%);
    color: var(--text-main); 
    font-family: 'Crimson Pro', serif;
    min-height: 100vh;
  }

  h1, label, button, .alert-title { font-family: 'Cinzel', serif; }

  /* Container Principal */
  .arcane-border {
    background-color: var(--panel-bg);
    border: 2px solid var(--gold-dim);
    box-shadow: 0 0 25px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.5);
    border-radius: 4px;
    position: relative;
    clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 0 20px, 20px 0);
  }

  /* Decoração de Canto */
  .corner-decoration {
    position: absolute;
    width: 25px; height: 25px;
    border: 2px solid var(--gold-primary);
    transition: all 0.5s ease;
    pointer-events: none;
  }
  .top-right { top: 12px; right: 12px; border-left: none; border-bottom: none; }
  .bottom-left { bottom: 12px; left: 12px; border-right: none; border-top: none; }

  /* Inputs Estilizados */
  .form-control, .form-select {
    background-color: #050505 !important;
    border: 1px solid #333 !important;
    border-bottom: 2px solid var(--gold-dim) !important;
    color: var(--gold-primary) !important;
    font-family: 'Crimson Pro', serif;
    font-size: 1.1rem;
    border-radius: 0 !important;
  }
  
  .form-control:focus, .form-select:focus {
    background-color: #0f0f12 !important;
    border-color: #333 !important;
    border-bottom-color: var(--gold-primary) !important;
    box-shadow: 0 5px 15px -10px rgba(212, 175, 55, 0.3) !important;
  }

  /* Botão de Enviar */
  .btn-arcane {
    background: linear-gradient(180deg, var(--crimson) 0%, #520000 100%);
    border: 1px solid #ff4444;
    color: #ffd700;
    text-transform: uppercase;
    letter-spacing: 2px;
    font-weight: bold;
    padding: 12px 30px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 0 #300000;
  }
  
  .btn-arcane:hover:not(:disabled) {
    background: linear-gradient(180deg, #b91212 0%, #7a0000 100%);
    box-shadow: 0 4px 0 #300000, 0 0 15px var(--crimson);
    color: white;
    transform: translateY(-2px);
  }
  
  .btn-arcane:active:not(:disabled) {
    transform: translateY(2px);
    box-shadow: 0 1px 0 #300000;
  }

  .btn-arcane:disabled {
    filter: grayscale(100%);
    cursor: wait;
  }

  /* Loading Dots Animation */
  .loading-dots::after {
    content: ''; animation: dots 1.5s infinite;
  }
  @keyframes dots {
    0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80% { content: '...'; }
  }

  /* Mensagem de Sucesso */
  .success-message {
    background: rgba(26, 77, 26, 0.6);
    border: 1px solid #2d7a2d;
    color: #d4f7d4;
    padding: 1rem;
    margin-bottom: 2rem;
    animation: fadeIn 0.5s ease;
    display: none; /* Oculto inicialmente */
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

</style>
</head>
<body>

  {% include "components/navbar.html" %}

  <div class="container py-5 mt-5">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        
        <div class="arcane-border p-5 md:p-8 relative z-10">
          <!-- Decorações -->
          <div class="corner-decoration top-right"></div>
          <div class="corner-decoration bottom-left"></div>

          <div class="text-center mb-8 border-b border-[#333] pb-4">
            <h1 class="text-3xl font-bold text-[#d4af37] mb-2 tracking-widest drop-shadow-md">
              [ CANAL COM OS MAGOS ]
            </h1>
            <p class="text-[#888] text-lg italic">
              Sua mensagem será arquivada nos registros da guilda para análise.
            </p>
          </div>

          <!-- Área de Sucesso (Oculta por padrão) -->
          <div id="successArea" class="success-message text-center rounded">
            <h3 class="text-xl alert-title mb-1">Registro Gravado!</h3>
            <p>Os arquimagos agradecem sua contribuição.</p>
            <button onclick="resetForm()" class="text-[#d4af37] hover:underline mt-2 inline-block text-sm uppercase font-bold bg-transparent border-0">
              Enviar outra mensagem
            </button>
          </div>

          <!-- Formulário -->
          <form id="feedbackForm" onsubmit="enviarFeedback(event)" class="space-y-6">
            
            <!-- Tipo de Feedback -->
            <div>
              <label class="block text-[#d4af37] text-sm uppercase font-bold mb-2 tracking-wider">Natureza da Mensagem</label>
              <select id="tipoFeedback" class="form-select w-full">
                <!-- Valores minúsculos para facilitar no Backend -->
                <option value="sugestao">Sugestão de Melhoria</option>
                <option value="bug">Reportar Erro (Bug)</option>
                <option value="elogio">Elogio / Outros</option>
              </select>
            </div>

            <!-- Mensagem -->
            <div>
              <label class="block text-[#d4af37] text-sm uppercase font-bold mb-2 tracking-wider">Sua Mensagem</label>
              <textarea id="msgFeedback" rows="6" required class="form-control w-full" placeholder="Descreva aqui..."></textarea>
            </div>

            <!-- Botão -->
            <div class="text-center pt-4">
              <button id="btnSubmit" type="submit" class="btn-arcane w-full md:w-auto">
                <span>GRAVAR NO GRIMÓRIO</span>
              </button>
            </div>
          </form>
          
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    async function enviarFeedback(event) {
      event.preventDefault();

      const btn = document.getElementById('btnSubmit');
      const originalText = btn.innerHTML;
      const form = document.getElementById('feedbackForm');
      const successArea = document.getElementById('successArea');
      
      const tipo = document.getElementById('tipoFeedback').value;
      const mensagem = document.getElementById('msgFeedback').value;

      btn.disabled = true;
      btn.innerHTML = '<span class="loading-dots">GRAVANDO</span>';

      try {
        const response = await fetch('/feedback/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            tipo: tipo,
            mensagem: mensagem
          })
        });

        const data = await response.json();

        if (response.ok) {
          form.style.display = 'none';
          successArea.style.display = 'block';
        } else {
          alert("Erro ao enviar: " + (data.error || "Tente novamente."));
        }

      } catch (error) {
        console.error(error);
        alert("Falha na conexão com o servidor.");
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function resetForm() {
      document.getElementById('feedbackForm').reset();
      document.getElementById('feedbackForm').style.display = 'block';
      document.getElementById('successArea').style.display = 'none';
    }
  </script>
</body>
</html>